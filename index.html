<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persist Event Cursor Widget</title>
</head>
<body>
  <!--
    Invisible widget that persists & restores the selected Event record across pages.
  -->

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    // 1) Initialize plugin: no permission prompts, only map the 'id' column
    grist.ready({
      requiredAccess: 'none',
      columns: ['id']
    });

    // Storage key for sessionStorage (scoped to Event table)
    const STORAGE_KEY = 'persist_cursor_Event';

    /**
     * restoreCursor()
     * Reads last saved rowId and tells Grist to select it.
     */
    async function restoreCursor() {
      const stored = sessionStorage.getItem(STORAGE_KEY);
      if (!stored) { return; }
      try {
        const {rowId} = JSON.parse(stored);
        // Only rowId is needed; sectionId is inferred
        await grist.setCursorPos({ rowId });
        console.log('✅ Restored Event cursor to row', rowId);
      } catch (err) {
        console.warn('⚠️ Failed to restore cursor:', err);
      }
    }

    // Restore as soon as the widget loads on each page
    window.addEventListener('load', restoreCursor);

    /**
     * onRecordChange(record)
     * Fires when the user selects a different Event record.
     * We grab record.id and save it.
     */
    grist.onRecord((record) => {
      // record.id exists because we mapped 'id' in ready(...)
      if (record && record.id != null) {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({ rowId: record.id }));
        console.log('💾 Stored Event cursor:', record.id);
      }
    });
  </script>
</body>
</html>
