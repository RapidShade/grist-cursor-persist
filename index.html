<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persist Event Cursor Widget</title>
</head>
<body>
  <!--
    Invisible widget that persists & restores the selected Event record
    across pages. Must be bound to the Event table, mapping only the 'id' field.
  -->

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    // 1) Tell Grist we’re ready, with no permission prompts and only mapping 'id'
    grist.ready({
      requiredAccess: 'none',
      columns: ['id'],
    });

    const STORAGE_KEY = 'persist_cursor_Event';

    /**
     * Reads the last-saved {tableId, rowId, colId} and
     * sets the document cursor there.
     */
    async function restoreCursor() {
      const stored = sessionStorage.getItem(STORAGE_KEY);
      if (!stored) { return; }
      try {
        const {tableId, rowId, colId} = JSON.parse(stored);
        await grist.setCursorPos({tableId, rowId, colId});
        console.log('✅ Restored cursor to', tableId, rowId, colId);
      } catch (err) {
        console.warn('⚠️ Failed to restore cursor:', err);
      }
    }

    // 2) Restore immediately on every page load
    window.addEventListener('load', restoreCursor);

    /**
     * Fires whenever the user picks a record in the Event table.
     * Saves the full cursor triple so we can restore it on other pages.
     */
    grist.onRecord((record) => {
      if (!record || record.id == null) { return; }
      const cursor = {
        tableId: 'Event',
        rowId: record.id,
        colId: 'id',  // column your SELECT BY widget is bound to
      };
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(cursor));
      console.log('💾 Stored cursor:', cursor);
    });
  </script>
</body>
</html>
