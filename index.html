<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Persist Event Cursor Widget</title>
</head>
<body>
  <!--
    Invisible widget that persists & restores the selected Event record
    across pages. Must be bound to the Event table, mapping only the 'id' field.
  -->

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    // 1) Initialize the plugin API:
    //    - requiredAccess: 'none' prevents any permission dialogs.
    //    - columns: ['id'] makes record.id available.
    grist.ready({
      requiredAccess: 'none',
      columns: ['id'],
    }).then(() => {

      const STORAGE_KEY = 'persist_cursor_Event';

      /** restoreCursor()
       *  Reads JSON {tableId, rowId, colId} and sets the document cursor there.
       */
      async function restoreCursor() {
        const stored = sessionStorage.getItem(STORAGE_KEY);
        if (!stored) { return; }
        try {
          const {tableId, rowId, colId} = JSON.parse(stored);
          await grist.setCursorPos({tableId, rowId, colId});
          console.log('✅ Restored cursor to', tableId, rowId, colId);
        } catch (err) {
          console.warn('⚠️ Failed to restore cursor:', err);
        }
      }

      // Restore immediately on load (after grist.ready)
      restoreCursor();

      /** onRecord callback
       *  Fires whenever the user changes the selected record in *this* page.
       *  We only get here if they select in the Event table (because of the binding),
       *  so we capture record.id and save the full cursor triple.
       */
      grist.onRecord((record) => {
        if (!record || record.id == null) { return; }
        const cursor = {
          tableId: 'Event',
          rowId: record.id,
          colId: 'id',    // the column your SELECT BY widget is bound to
        };
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(cursor));
        console.log('💾 Stored cursor:', cursor);
      });
    });
  </script>
</body>
</html>
